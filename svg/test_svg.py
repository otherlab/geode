#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import division
from other.core import *
import sys

# http://www.w3.org/TR/SVG/images/paths/cubic02.svg
cubic02 = ('''\
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" 
  "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="10cm" height="10cm" viewBox="0 0 1000 1000"
     xmlns="http://www.w3.org/2000/svg" version="1.1">
  <title>Example cubic02 - cubic BÃ©zier commands in path data</title>
  <desc>Picture showing examples of "C" and "S" commands,
        along with annotations showing the control points
        and end points</desc>
  <style type="text/css"><![CDATA[
    .Border { fill:none; stroke:blue; stroke-width:1 }
    .Connect { fill:none; stroke:#888888; stroke-width:2 }
    .SamplePath { fill:none; stroke:red; stroke-width:5 }
    .EndPoint { fill:none; stroke:#888888; stroke-width:2 }
    .CtlPoint { fill:#888888; stroke:none }
    .AutoCtlPoint { fill:none; stroke:blue; stroke-width:4 }
    .Label { text-anchor:middle; font-size:22; font-family:Verdana }
  ]]></style>

  <rect class="Border" x="1" y="1" width="998" height="998" />

  <!-- Path 1 -->
  <polyline class="Connect" points="100,200 100,100" />
  <polyline class="Connect" points="400,100 400,200" />
  <path class="SamplePath" d="M100,200 C100,100 400,100 400,200" />
  <circle class="EndPoint" cx="100" cy="200" r="10" />
  <circle class="EndPoint" cx="400" cy="200" r="10" />
  <circle class="CtlPoint" cx="100" cy="100" r="10" />
  <circle class="CtlPoint" cx="400" cy="100" r="10" />
  <text class="Label" x="250" y="275">M100,200 C100,100 400,100 400,200</text>

  <!-- Path 2 -->
  <polyline class="Connect" points="100,500 25,400" />
  <polyline class="Connect" points="475,400 400,500" />
  <path class="SamplePath" d="M100,500 C25,400 475,400 400,500" />
  <circle class="EndPoint" cx="100" cy="500" r="10" />
  <circle class="EndPoint" cx="400" cy="500" r="10" />
  <circle class="CtlPoint" cx="25" cy="400" r="10" />
  <circle class="CtlPoint" cx="475" cy="400" r="10" />
  <text class="Label" x="250" y="575">M100,500 C25,400 475,400 400,500</text>

  <!-- Path 3 -->
  <polyline class="Connect" points="100,800 175,700" />
  <polyline class="Connect" points="325,700 400,800" />
  <path class="SamplePath" d="M100,800 C175,700 325,700 400,800" />
  <circle class="EndPoint" cx="100" cy="800" r="10" />
  <circle class="EndPoint" cx="400" cy="800" r="10" />
  <circle class="CtlPoint" cx="175" cy="700" r="10" />
  <circle class="CtlPoint" cx="325" cy="700" r="10" />
  <text class="Label" x="250" y="875">M100,800 C175,700 325,700 400,800</text>

  <!-- Path 4 -->
  <polyline class="Connect" points="600,200 675,100" />
  <polyline class="Connect" points="975,100 900,200" />
  <path class="SamplePath" d="M600,200 C675,100 975,100 900,200" />
  <circle class="EndPoint" cx="600" cy="200" r="10" />
  <circle class="EndPoint" cx="900" cy="200" r="10" />
  <circle class="CtlPoint" cx="675" cy="100" r="10" />
  <circle class="CtlPoint" cx="975" cy="100" r="10" />
  <text class="Label" x="750" y="275">M600,200 C675,100 975,100 900,200</text>

  <!-- Path 5 -->
  <polyline class="Connect" points="600,500 600,350" />
  <polyline class="Connect" points="900,650 900,500" />
  <path class="SamplePath" d="M600,500 C600,350 900,650 900,500" />
  <circle class="EndPoint" cx="600" cy="500" r="10" />
  <circle class="EndPoint" cx="900" cy="500" r="10" />
  <circle class="CtlPoint" cx="600" cy="350" r="10" />
  <circle class="CtlPoint" cx="900" cy="650" r="10" />
  <text class="Label" x="750" y="575">M600,500 C600,350 900,650 900,500</text>

  <!-- Path 6 (C and S command) -->
  <polyline class="Connect" points="600,800 625,700" />
  <polyline class="Connect" points="725,700 750,800" />
  <polyline class="Connect" points="750,800 775,900" />
  <polyline class="Connect" points="875,900 900,800" />
  <path class="SamplePath" d="M600,800 C625,700 725,700 750,800
                                       S875,900 900,800" />
  <circle class="EndPoint" cx="600" cy="800" r="10" />
  <circle class="EndPoint" cx="750" cy="800" r="10" />
  <circle class="EndPoint" cx="900" cy="800" r="10" />
  <circle class="CtlPoint" cx="625" cy="700" r="10" />
  <circle class="CtlPoint" cx="725" cy="700" r="10" />
  <circle class="CtlPoint" cx="875" cy="900" r="10" />
  <circle class="AutoCtlPoint" cx="775" cy="900" r="9" />
  <text class="Label" x="750" y="945">M600,800 C625,700 725,700 750,800</text>
  <text class="Label" x="750" y="975">S875,900 900,800</text>
</svg>
''',
[[[766,900],[767,896],[769,894],[771,892],[775,891],[779,892],[781,894],[783,896],[784,900],[783,904],[781,906],[779,908],[775,909],[771,908],[769,906],[767,904],[766,900]],[[865,900],[866,896],[868,893],[871,891],[875,890],[879,891],[882,893],[884,896],[885,900],[884,904],[882,907],[879,909],[875,910],[871,909],[868,907],[866,904],[865,900]],[[715,700],[716,696],[718,693],[721,691],[725,690],[729,691],[732,693],[734,696],[735,700],[734,704],[732,707],[729,709],[725,710],[721,709],[718,707],[716,704],[715,700]],[[615,700],[616,696],[618,693],[621,691],[625,690],[629,691],[632,693],[634,696],[635,700],[634,704],[632,707],[629,709],[625,710],[621,709],[618,707],[616,704],[615,700]],[[890,800],[891,796],[893,793],[896,791],[900,790],[904,791],[907,793],[909,796],[910,800],[909,804],[907,807],[904,809],[900,810],[896,809],[893,807],[891,804],[890,800]],[[740,800],[741,796],[743,793],[746,791],[750,790],[754,791],[757,793],[759,796],[760,800],[759,804],[757,807],[754,809],[750,810],[746,809],[743,807],[741,804],[740,800]],[[590,800],[591,796],[593,793],[596,791],[600,790],[604,791],[607,793],[609,796],[610,800],[609,804],[607,807],[604,809],[600,810],[596,809],[593,807],[591,804],[590,800]],[[600,800],[630,744],[675,725],[720,744],[750,800],[780,856],[825,875],[870,856],[900,800]],[[875,900],[881,875],[887,850],[894,825],[900,800]],[[750,800],[756,825],[762,850],[769,875],[775,900]],[[725,700],[731,725],[737,750],[744,775],[750,800]],[[600,800],[606,775],[612,750],[619,725],[625,700]],[[890,650],[891,646],[893,643],[896,641],[900,640],[904,641],[907,643],[909,646],[910,650],[909,654],[907,657],[904,659],[900,660],[896,659],[893,657],[891,654],[890,650]],[[590,350],[591,346],[593,343],[596,341],[600,340],[604,341],[607,343],[609,346],[610,350],[609,354],[607,357],[604,359],[600,360],[596,359],[593,357],[591,354],[590,350]],[[890,500],[891,496],[893,493],[896,491],[900,490],[904,491],[907,493],[909,496],[910,500],[909,504],[907,507],[904,509],[900,510],[896,509],[893,507],[891,504],[890,500]],[[590,500],[591,496],[593,493],[596,491],[600,490],[604,491],[607,493],[609,496],[610,500],[609,504],[607,507],[604,509],[600,510],[596,509],[593,507],[591,504],[590,500]],[[600,500],[647,458],[750,500],[853,542],[900,500]],[[900,650],[900,612],[900,575],[900,538],[900,500]],[[600,500],[600,462],[600,425],[600,388],[600,350]],[[965,100],[966,96],[968,93],[971,91],[975,90],[979,91],[982,93],[984,96],[985,100],[984,104],[982,107],[979,109],[975,110],[971,109],[968,107],[966,104],[965,100]],[[665,100],[666,96],[668,93],[671,91],[675,90],[679,91],[682,93],[684,96],[685,100],[684,104],[682,107],[679,109],[675,110],[671,109],[668,107],[666,104],[665,100]],[[890,200],[891,196],[893,193],[896,191],[900,190],[904,191],[907,193],[909,196],[910,200],[909,204],[907,207],[904,209],[900,210],[896,209],[893,207],[891,204],[890,200]],[[590,200],[591,196],[593,193],[596,191],[600,190],[604,191],[607,193],[609,196],[610,200],[609,204],[607,207],[604,209],[600,210],[596,209],[593,207],[591,204],[590,200]],[[600,200],[689,144],[806,125],[895,144],[900,200]],[[975,100],[956,125],[937,150],[919,175],[900,200]],[[600,200],[619,175],[638,150],[656,125],[675,100]],[[315,700],[316,696],[318,693],[321,691],[325,690],[329,691],[332,693],[334,696],[335,700],[334,704],[332,707],[329,709],[325,710],[321,709],[318,707],[316,704],[315,700]],[[165,700],[166,696],[168,693],[171,691],[175,690],[179,691],[182,693],[184,696],[185,700],[184,704],[182,707],[179,709],[175,710],[171,709],[168,707],[166,704],[165,700]],[[390,800],[391,796],[393,793],[396,791],[400,790],[404,791],[407,793],[409,796],[410,800],[409,804],[407,807],[404,809],[400,810],[396,809],[393,807],[391,804],[390,800]],[[90,800],[91,796],[93,793],[96,791],[100,790],[104,791],[107,793],[109,796],[110,800],[109,804],[107,807],[104,809],[100,810],[96,809],[93,807],[91,804],[90,800]],[[100,800],[168,744],[250,725],[332,744],[400,800]],[[325,700],[344,725],[362,750],[381,775],[400,800]],[[100,800],[119,775],[138,750],[156,725],[175,700]],[[465,400],[466,396],[468,393],[471,391],[475,390],[479,391],[482,393],[484,396],[485,400],[484,404],[482,407],[479,409],[475,410],[471,409],[468,407],[466,404],[465,400]],[[15,400],[16,396],[18,393],[21,391],[25,390],[29,391],[32,393],[34,396],[35,400],[34,404],[32,407],[29,409],[25,410],[21,409],[18,407],[16,404],[15,400]],[[390,500],[391,496],[393,493],[396,491],[400,490],[404,491],[407,493],[409,496],[410,500],[409,504],[407,507],[404,509],[400,510],[396,509],[393,507],[391,504],[390,500]],[[90,500],[91,496],[93,493],[96,491],[100,490],[104,491],[107,493],[109,496],[110,500],[109,504],[107,507],[104,509],[100,510],[96,509],[93,507],[91,504],[90,500]],[[100,500],[126,444],[250,425],[374,444],[400,500]],[[475,400],[456,425],[438,450],[419,475],[400,500]],[[100,500],[81,475],[62,450],[44,425],[25,400]],[[390,100],[391,96],[393,93],[396,91],[400,90],[404,91],[407,93],[409,96],[410,100],[409,104],[407,107],[404,109],[400,110],[396,109],[393,107],[391,104],[390,100]],[[90,100],[91,96],[93,93],[96,91],[100,90],[104,91],[107,93],[109,96],[110,100],[109,104],[107,107],[104,109],[100,110],[96,109],[93,107],[91,104],[90,100]],[[390,200],[391,196],[393,193],[396,191],[400,190],[404,191],[407,193],[409,196],[410,200],[409,204],[407,207],[404,209],[400,210],[396,209],[393,207],[391,204],[390,200]],[[90,200],[91,196],[93,193],[96,191],[100,190],[104,191],[107,193],[109,196],[110,200],[109,204],[107,207],[104,209],[100,210],[96,209],[93,207],[91,204],[90,200]],[[100,200],[147,144],[250,125],[353,144],[400,200]],[[400,100],[400,125],[400,150],[400,175],[400,200]],[[100,200],[100,175],[100,150],[100,125],[100,100]],[[1,1],[251,1],[500,1],[750,1],[999,1],[999,251],[999,500],[999,750],[999,999],[750,999],[500,999],[251,999],[1,999],[1,750],[1,500],[1,251],[1,1]]])

# http://www.w3.org/TR/SVG/images/paths/arcs01.svg
arcs01 = ('''\
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" 
  "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="12cm" height="5.25cm" viewBox="0 0 1200 400"
     xmlns="http://www.w3.org/2000/svg" version="1.1">
  <title>Example arcs01 - arc commands in path data</title>
  <desc>Picture of a pie chart with two pie wedges and
        a picture of a line with arc blips</desc>
  <rect x="1" y="1" width="1198" height="398"
        fill="none" stroke="blue" stroke-width="1" />

  <path d="M300,200 h-150 a150,150 0 1,0 150,-150 z"
        fill="red" stroke="blue" stroke-width="5" />
  <path d="M275,175 v-150 a150,150 0 0,0 -150,150 z"
        fill="yellow" stroke="blue" stroke-width="5" />

  <path d="M600,350 l 50,-25 
           a25,25 -30 0,1 50,-25 l 50,-25 
           a25,50 -30 0,1 50,-25 l 50,-25 
           a25,75 -30 0,1 50,-25 l 50,-25 
           a25,100 -30 0,1 50,-25 l 50,-25"
        fill="none" stroke="red" stroke-width="5"  />
</svg>
''',
[[[600,350],[612,344],[625,337],[637,331],[650,325],[647,314],[648,304],[654,294],[662,288],[673,285],[684,286],[693,291],[700,300],[712,294],[725,288],[737,281],[750,275],[741,255],[738,237],[740,222],[748,214],[760,213],[773,219],[787,232],[800,250],[812,244],[825,237],[838,231],[850,225],[836,196],[828,170],[827,150],[834,140],[847,141],[863,152],[882,173],[900,200],[912,194],[925,188],[938,181],[950,175],[930,136],[918,103],[914,78],[920,66],[934,68],[953,85],[976,113],[1000,150],[1012,144],[1025,137],[1037,131],[1050,125]],[[275,175],[275,137],[275,100],[275,62],[275,25],[217,37],[169,69],[137,117],[125,175]],[[300,200],[262,200],[225,200],[187,200],[150,200],[162,258],[194,306],[242,338],[300,350],[358,338],[406,306],[438,258],[450,200],[438,142],[406,94],[358,62],[300,50]],[[1,1],[301,1],[600,1],[900,1],[1199,1],[1199,101],[1199,200],[1199,300],[1199,399],[900,399],[600,399],[301,399],[1,399],[1,300],[1,200],[1,101],[1,1]]])

# Part of http://www.w3.org/TR/SVG/images/paths/arcs02.svg
arcs02 = ('''\
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
  "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="12cm" height="5.25cm" viewBox="0 0 1200 525" version="1.1"
     xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <title>Example arcs02 - arc options in paths</title>
  <desc>Pictures showing the result of setting
        large-arc-flag and sweep-flag to the four
        possible combinations of 0 and 1.</desc>
  <g font-family="Verdana" >
    <rect x="1" y="1" width="1198" height="523"
          fill="none" stroke="blue" stroke-width="1" />

    <g font-size="30" >
      <g transform="translate(400,0)">
        <path d="M 125,75 a100,50 0 0,0 100,50"
              fill="none" stroke="red" stroke-width="6" />
      </g>
      <g transform="translate(800,0)">
        <path d="M 125,75 a100,50 0 0,1 100,50"
              fill="none" stroke="red" stroke-width="6" />
      </g>
      <g transform="translate(400,250)">
        <path d="M 125,75 a100,50 0 1,0 100,50"
              fill="none" stroke="red" stroke-width="6" />
      </g>
      <g transform="translate(800,250)">
        <path d="M 125,75 a100,50 0 1,1 100,50"
              fill="none" stroke="red" stroke-width="6" />
      </g>
    </g>
  </g>
</svg>
''',
[[[925,325],[933,306],[954,290],[986,279],[1025,275],[1064,279],[1096,290],[1117,306],[1125,325],[1117,344],[1096,360],[1064,371],[1025,375]],[[525,325],[486,329],[454,340],[433,356],[425,375],[433,394],[454,410],[486,421],[525,425],[564,421],[596,410],[617,394],[625,375]],[[925,75],[964,79],[996,90],[1017,106],[1025,125]],[[525,75],[533,94],[554,110],[586,121],[625,125]],[[1,1],[301,1],[600,1],[900,1],[1199,1],[1199,132],[1199,263],[1199,393],[1199,524],[900,524],[600,524],[301,524],[1,524],[1,393],[1,263],[1,132],[1,1]]])

def svg_test(name,svg,known):
  beziers = svgstring_to_beziers(svg) 
  sig = [rint(b.evaluate(4)).astype(int) for b in beziers]
  sig,known = map(compact_str,(sig,known))
  if sig!=known:
    print 'sig = %s'%sig 
    if '-d' in sys.argv:
      import pylab
      for bezier in beziers:
        X = bezier.evaluate(20)
        pylab.plot(X[:,0],-X[:,1])
      pylab.axes().set_aspect('equal')
      pylab.show()
    if sig!=known:
      print '\n%s:'%name
      print 'sig   = %s'%sig
      print
      print 'known = %s'%known
      assert sig==known

def test_svg():
  svg_test('cubic02',*cubic02)
  svg_test('arcs01',*arcs01)
  svg_test('arcs02',*arcs02)

if __name__=='__main__': 
  test_svg()
